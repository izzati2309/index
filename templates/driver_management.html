<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
   <meta http-equiv="Pragma" content="no-cache">
   <meta http-equiv="Expires" content="0">
   <title>Driver Management | UBUS Admin</title>
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <style>
        /* Header Styles */
        .header-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .search-container {
            max-width: 600px;
        }

        .search-container .input-group-text {
            border-radius: 8px 0 0 8px;
        }

        .search-container input {
            border-radius: 0 8px 8px 0;
            padding: 0.75rem 1rem;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .navbar {
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            background-color: #4361ee !important;
        }

        .navbar-brand {
            font-weight: bold;
            position: relative;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            transform: translateY(-2px);
        }

        .nav-item {
            position: relative;
            margin: 0 0.25rem;
        }

        .nav-link {
            padding: 0.8rem 1.2rem !important;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-link:before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background-color: #fff;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-link:hover:before {
            width: 100%;
        }

        .nav-item:hover .nav-link {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .nav-item.active .nav-link {
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .nav-item.active .nav-link:before {
            width: 100%;
        }

        .navbar-toggler {
            border: none;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        .navbar-toggler:hover {
            transform: scale(1.1);
        }

        .navbar-toggler:focus {
            outline: none;
            box-shadow: none;
        }

        .nav-icon {
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover .nav-icon {
            transform: scale(1.2);
        }

        /* Ripple effect */
        .nav-link {
            position: relative;
        }

        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        } 

       .ripple {
           position: absolute;
           background: rgba(255, 255, 255, 0.3);
           border-radius: 50%;
           transform: scale(0);
           animation: ripple 0.6s linear;
           pointer-events: none;
       }
       @keyframes ripple {
           to {
               transform: scale(4);
               opacity: 0;
           }
       }
       .dashboard-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .dashboard-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .add-driver-btn {
            background: white;
            color: #007bff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .add-driver-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            background: #f8f9fa;
        }

        .driver-list-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-box input {
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .driver-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .driver-info {
            margin: 1rem 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .info-row {
            display: flex;
            justify-content: flex-start;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-item i {
            min-width: 1rem;
            color: #007bff;
        }

        .info-item span {
            color: #666;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
        }

        .button-group .btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .driver-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
            color: white;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
            color: white;
        }

        /* Map Container */
        .map-section .card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .map-section .card-header {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .map-section .card-header:hover {
            background-color: #f8f9fa;
        }

        /* Table Styles */
        .table th {
            cursor: pointer;
            padding: 1rem;
            white-space: nowrap;
        }

        .sortable {
            position: relative;
        }

        .sortable:hover {
            background-color: #f8f9fa;
        }

        .sortable::after {
            content: '↕';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }

        .table td {
            vertical-align: middle;
            padding: 1rem;
        }

        /* Action Buttons */
        .action-btn {
            padding: 0.4rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .gap-2 {
            gap: 0.5rem;
        }

        /* Additional Utility Classes */
        .cursor-pointer {
            cursor: pointer;
        }

        /* Enhanced Modals */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            border: none;
            border-radius: 12px;
        }

        .modal-header {
            background: #007bff;
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        select.form-control {
            height: auto !important;
            padding: 0.75rem !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        /* Ensure dropdown options are visible */
        select.form-control option {
            padding: 0.5rem;
            font-size: 1rem;
        }

        select.form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Style for form labels */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #212529;
        }

        /* Modal footer buttons */
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        .btn-secondary {
            background-color: #6c757d;
            border: 1px solid #6c757d;
            color: white;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: 1px solid #0d6efd;
            color: white;
        }

        /* Add responsive sizing for the route select */
        @media (min-width: 576px) {
            select.form-control {
                min-height: 3rem;
                max-height: none;
            }
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        /* Enhanced Alert Styles */
        .alert {
            border-radius: 10px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Activity Log Enhancements */
        .activity-log {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* PDF-specific styles */
        .pdf-container {
            background: white;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .pdf-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .pdf-container th,
        .pdf-container td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .pdf-container th {
            background-color: #f8f9fa;
        }

        .pdf-container h2 {
            color: #007bff;
            margin-bottom: 20px;
        }

        @keyframes bounceIn {
            from {
                opacity: 0;
                transform: scale(0.3);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate__animated {
            animation-duration: 0.5s;
        }

        .animate__bounceIn {
            animation-name: bounceIn;
        }

        .animate__fadeOut {
            animation-name: fadeOut;
        }

        @keyframes bounceIn {
            from {
                opacity: 0;
                transform: scale3d(0.3, 0.3, 0.3);
            }
            50% {
                opacity: 1;
                transform: scale3d(1.1, 1.1, 1.1);
            }
            to {
                transform: scale3d(1, 1, 1);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
   </style>
</head>

<body>
   <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin_dashboard">
                <i class="fas fa-bus-alt nav-icon"></i>UBUS Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin_dashboard">
                            <i class="fas fa-tachometer-alt nav-icon"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/routes_management">
                            <i class="fas fa-route nav-icon"></i>Routes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/schedules_management">
                            <i class="fas fa-clock nav-icon"></i>Schedules
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">
                            <i class="fas fa-chart-line nav-icon"></i>Analytics
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/driver_management">
                            <i class="fas fa-users nav-icon"></i>Drivers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/optimization">
                            <i class="fas fa-magic nav-icon"></i>Optimization
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/accounts">
                            <i class="fas fa-users nav-icon"></i>Accounts
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin_logout">
                            <i class="fas fa-sign-out-alt nav-icon"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

   <div class="container-fluid p-4">
        <!-- Top Section -->
        <div class="header-section mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="d-flex align-items-center gap-2">
                    <i class="fas fa-users-cog text-primary"></i>
                    Driver Management
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-info d-flex align-items-center gap-2" onclick="printDriverList()">
                        <i class="fas fa-file-pdf"></i>
                        Export PDF
                    </button>
                    <button class="btn btn-primary d-flex align-items-center gap-2" data-toggle="modal" data-target="#addDriverModal">
                        <i class="fas fa-plus-circle"></i>
                        Add New Driver
                    </button>
                </div>
            </div>
        </div>

        <!-- Middle Section - Collapsible Map -->
        <div class="map-section mb-4">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center cursor-pointer" 
                    data-toggle="collapse" data-target="#mapContainer">
                    <h5 class="mb-0 d-flex align-items-center gap-2">
                        <i class="fas fa-map-marked-alt text-primary"></i>
                        Real-time Driver Locations
                    </h5>
                    <button class="btn btn-light btn-sm" id="toggleMap">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="collapse show" id="mapContainer">
                    <div class="card-body p-0">
                        <div id="map" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Bottom Section - Driver List -->
        <div class="driver-list-section">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="bg-light">
                                <tr>
                                    <th class="sortable" data-sort="name">
                                        <i class="fas fa-user text-primary"></i> Name
                                    </th>
                                    <th class="sortable" data-sort="email">
                                        <i class="fas fa-envelope text-primary"></i> Email
                                    </th>
                                    <th class="sortable" data-sort="phone">
                                        <i class="fas fa-phone text-primary"></i> Phone
                                    </th>
                                    <th class="sortable" data-sort="route">
                                        <i class="fas fa-route text-primary"></i> Route
                                    </th>
                                    <th class="sortable" data-sort="license">
                                        <i class="fas fa-id-card text-primary"></i> License
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="driversList">
                                <!-- Drivers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- Add Driver Modal -->
   <div class="modal fade" id="addDriverModal">
       <div class="modal-dialog">
           <div class="modal-content">
               <div class="modal-header">
                   <h5 class="modal-title">Add New Driver</h5>
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
               </div>
               <div class="modal-body">
                    <form id="driverForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" name="phone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>License Number</label>
                            <input type="text" name="license" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Assign Route</label>
                            <select class="form-control" name="route_id" required style="min-height: 3rem;">
                                <option value="">Select Route</option>
                                {% for route in routes %}
                                <option value="{{ route.id }}">{{ route.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
               </div>
               <div class="modal-footer">
                   <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                   <button type="submit" form="driverForm" class="btn btn-primary">Save Driver</button>
               </div>
           </div>
       </div>
   </div>

   <!-- Confirmation Modal -->
   <div class="modal fade" id="confirmationModal">
       <div class="modal-dialog">
           <div class="modal-content">
               <div class="modal-header bg-warning">
                   <h5 class="modal-title">
                       <i class="fas fa-exclamation-triangle mr-2"></i>
                       Confirm Action
                   </h5>
                   <button type="button" class="close" data-dismiss="modal">&times;</button>
               </div>
               <div class="modal-body">
                   <p id="confirmationMessage"></p>
               </div>
               <div class="modal-footer">
                   <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                   <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
               </div>
           </div>
       </div>
   </div>

   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
   
   <script>
        function checkLoginState() {
            fetch('/check_session', {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.logged_in) {
                    window.location.href = '/auth_login';
                }
            })
            .catch(error => {
                console.error('Session check failed:', error);
                window.location.href = '/auth_login';
            });
        }

        // Check session when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                checkLoginState();
            }
        });

        // Check session periodically
        setInterval(checkLoginState, 60000); // Check every minute

        // Check when page loads
        document.addEventListener('DOMContentLoaded', checkLoginState);

        // Check when navigating back
        window.onpageshow = function(event) {
            if (event.persisted) {
                checkLoginState();
            }
        };

        // Disable back button
        history.pushState(null, null, location.href);
        window.onpopstate = function() {
            history.go(1);
        };

       $(document).ready(function() {
            let map;
            let markers = {};

            function initMap() {
                // Initialize map centered on Shah Alam
                map = L.map('map').setView([3.0733, 101.5185], 13);
                
                // Add hybrid satellite layer with road labels
                L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    attribution: '© Google Maps'
                }).addTo(map);
            }

            function updateDriverLocations() {
                $.get('/test_gis', function(drivers) {
                    // Clear existing markers
                    Object.values(markers).forEach(marker => map.removeLayer(marker));
                    markers = {};

                    drivers.forEach(driver => {
                        if (driver.lat && driver.lng) {
                            // Create or update marker
                            const marker = L.marker([driver.lat, driver.lng])
                                .bindPopup(`
                                    <strong>${driver.name}</strong><br>
                                    Route: ${driver.route || 'Unassigned'}<br>
                                    Last Update: ${driver.last_update || 'N/A'}
                                `);
                            
                            marker.addTo(map);
                            markers[driver.name] = marker;
                        }
                    });

                    // Center map on first driver with location
                    const firstDriver = drivers.find(d => d.lat && d.lng);
                    if (firstDriver) {
                        map.setView([firstDriver.lat, firstDriver.lng], 13);
                    }
                });
            }

            // Initialize map
            initMap();

            // Update locations immediately and every 10 seconds
            updateDriverLocations();
            setInterval(updateDriverLocations, 10000);

           function showConfirmation(message, callback) {
               $('#confirmationMessage').text(message);
               $('#confirmActionBtn').off('click').on('click', function() {
                   $('#confirmationModal').modal('hide');
                   callback();
               });
               $('#confirmationModal').modal('show');
           }

           setInterval(function() {
               $.get('/check_session', function(response) {
                   if (!response.logged_in) window.location.href = '/admin_login';
               });
           }, 300000);

           loadDrivers();

           // Update the form submission success handler
            $('#driverForm').on('submit', function(e) {
                e.preventDefault();
                const driverId = $(this).data('driver-id');
                const title = driverId ? 'Update' : 'Add';
                
                // Get the email to generate username
                const email = $(this).find('input[name="email"]').val();
                const username = email.split('@')[0];
                
                // Generate random password
                const password = Math.random().toString(36).slice(-8);
                
                const formData = {
                    username: username,
                    password: password,
                    name: $(this).find('input[name="name"]').val(),
                    phone: $(this).find('input[name="phone"]').val(),
                    email: email,
                    license: $(this).find('input[name="license"]').val(),
                    route_id: $(this).find('select[name="route_id"]').val()
                };

                showConfirmation(`Are you sure you want to ${title.toLowerCase()} this driver?`, function() {
                    $.ajax({
                        url: driverId ? `/api/drivers/${driverId}` : '/api/drivers',
                        type: driverId ? 'PUT' : 'POST',
                        data: formData,
                        success: function(response) {
                            $('#addDriverModal').modal('hide');
                            if (!driverId) {
                                // Show the interactive success modal
                                showSuccessAlert(username, password);
                            }
                            $('#driverForm')[0].reset();
                            loadDrivers();
                        },
                        error: function(xhr) {
                            showAlert(xhr.responseJSON?.message || `Error ${driverId ? 'updating' : 'adding'} driver`, 'danger');
                        }
                    });
                });
            });

            function showSuccessAlert(username, password) {
                // Remove any existing success modals
                $('.success-credentials-modal').remove();
                
                const modalHtml = `
                <div class="modal fade success-credentials-modal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0">
                            <div class="modal-body text-center p-4">
                                <div class="mb-4">
                                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                                </div>
                                <h4 class="text-success mb-4">Driver added successfully!</h4>
                                
                                <div class="card bg-light mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">Driver Credentials</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">Username</span>
                                            </div>
                                            <input type="text" class="form-control" value="${username}" readonly>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary copy-btn" data-copy="${username}">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">Password</span>
                                            </div>
                                            <input type="text" class="form-control" value="${password}" readonly>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary copy-btn" data-copy="${password}">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Please save these credentials! You won't be able to see them again.
                                </div>
                                
                                <button type="button" class="btn btn-success px-4" data-dismiss="modal">
                                    <i class="fas fa-check mr-2"></i>Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;

                // Add modal to body
                $('body').append(modalHtml);
                
                // Initialize copy buttons
                $('.copy-btn').click(function() {
                    const textToCopy = $(this).data('copy');
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // Show copied tooltip
                        const $btn = $(this);
                        const originalHtml = $btn.html();
                        $btn.html('<i class="fas fa-check"></i>');
                        setTimeout(() => {
                            $btn.html(originalHtml);
                        }, 1000);
                    });
                });

                // Show the modal
                $('.success-credentials-modal').modal({
                    backdrop: 'static',
                    keyboard: false
                });
            }
            
           $('#addDriverModal').on('hidden.bs.modal', function() {
               $('#driverForm')[0].reset();
               $('#driverForm').removeData('driver-id');
               $('.modal-title').text('Add New Driver');
           });

           window.editDriver = function(id) {
               $.get(`/api/drivers/${id}`, function(driver) {
                   $('#driverForm').find('input[name="name"]').val(driver.name);
                   $('#driverForm').find('input[name="phone"]').val(driver.phone);
                   $('#driverForm').find('input[name="email"]').val(driver.email);
                   $('#driverForm').find('input[name="license"]').val(driver.license_number);
                   $('#driverForm').find('select[name="route_id"]').val(driver.route_id);
                   $('#driverForm').data('driver-id', id);
                   $('.modal-title').text('Edit Driver');
                   $('#addDriverModal').modal('show');
               });
           };

           window.deleteDriver = function(id) {
               showConfirmation('Are you sure you want to delete this driver?', function() {
                   $.ajax({
                       url: `/api/drivers/${id}`,
                       type: 'DELETE',
                       success: function(response) {
                           showAlert('Driver deleted successfully!', 'success');
                           loadDrivers();
                       },
                       error: function(xhr) {
                           showAlert(xhr.responseJSON?.message || 'Error deleting driver', 'danger');
                       }
                   });
               });
           };

           function createDriverCard(driver) {
                return `
                    <div class="driver-card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-user-circle text-primary mr-2"></i>
                                ${driver.name}
                            </h5>
                            <div class="driver-info">
                                <div class="info-item">
                                    <i class="fas fa-envelope text-primary"></i>
                                    ${driver.email}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-phone text-primary"></i>
                                    ${driver.phone}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-route text-primary"></i>
                                    ${driver.route_name}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-id-card text-primary"></i>
                                    ${driver.license_number}
                                </div>
                            </div>
                            <div class="driver-actions">
                                <button class="action-btn edit-btn" onclick="window.editDriver(${driver.id})">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </button>
                                <button class="action-btn delete-btn" onclick="window.deleteDriver(${driver.id})">
                                    <i class="fas fa-trash-alt"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function loadDrivers() {
                $.get('/api/drivers', function(drivers) {
                    const driversList = $('#driversList');
                    driversList.empty();
                    
                    drivers.forEach(driver => {
                        driversList.append(`
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas fa-user-circle text-primary"></i>
                                        ${driver.name}
                                    </div>
                                </td>
                                <td>${driver.email}</td>
                                <td>${driver.phone}</td>
                                <td>${driver.route_name || 'Unassigned'}</td>
                                <td>${driver.license_number}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-primary action-btn" 
                                                onclick="window.editDriver(${driver.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger action-btn" 
                                                onclick="window.deleteDriver(${driver.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                });
            }

            // Toggle map collapse
            $('#toggleMap').click(function(e) {
                e.preventDefault();
                const icon = $(this).find('i');
                icon.toggleClass('fa-chevron-up fa-chevron-down');
            });

            // Search functionality
            $('#searchDriver').on('keyup', function() {
                const value = $(this).val().toLowerCase();
                $("#driversList tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            // Sorting functionality
            $('.sortable').click(function() {
                const table = $(this).parents('table').eq(0);
                const rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()));
                this.asc = !this.asc;
                if (!this.asc) rows.reverse();
                for (let i = 0; i < rows.length; i++) {
                    table.append(rows[i]);
                }
            });

            function comparer(index) {
                return function(a, b) {
                    const valA = getCellValue(a, index);
                    const valB = getCellValue(b, index);
                    return $.isNumeric(valA) && $.isNumeric(valB) ?
                        valA - valB : valA.localeCompare(valB);
                }
            }

            function getCellValue(row, index) {
                return $(row).children('td').eq(index).text();
            }

            // Initialize page
            $(document).ready(function() {
                loadDrivers();
            });

                function showAlert(message, type) {
                $('.alert').remove();
                const alert = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>
                `;
                $('.container-fluid').first().prepend(alert);
                
                setTimeout(function() {
                    $('.alert').fadeOut('slow', function() {
                        $(this).remove();
                    });
                }, 3000);
                }
                });
            
                function printDriverList() {
                    $.get('/api/drivers', function(drivers) {
                        try {
                            const doc = new jspdf.jsPDF('landscape');
                            
                            // Set up the document
                            doc.setFontSize(20);
                            doc.setTextColor(0, 123, 255);
                            doc.text('UBUS Driver Management System', 15, 20);
                            
                            doc.setFontSize(14);
                            doc.setTextColor(100);
                            doc.text('Driver List Report', 15, 30);
                            
                            // Add timestamp
                            doc.setFontSize(10);
                            doc.text(`Generated on: ${new Date().toLocaleString()}`, 15, 40);

                            // Table configuration
                            const headers = [['Name', 'Email', 'Phone', 'Route', 'License']];
                            const data = drivers.map(driver => [
                                driver.name,
                                driver.email,
                                driver.phone,
                                driver.route_name || 'Unassigned',
                                driver.license_number
                            ]);

                            // Generate table
                            doc.autoTable({
                                startY: 50,
                                head: headers,
                                body: data,
                                theme: 'grid',
                                styles: {
                                    fontSize: 10,
                                    cellPadding: 5
                                },
                                headStyles: {
                                    fillColor: [0, 123, 255],
                                    textColor: 255
                                },
                                columnStyles: {
                                    0: { cellWidth: 40 },
                                    1: { cellWidth: 60 },
                                    2: { cellWidth: 40 },
                                    3: { cellWidth: 40 },
                                    4: { cellWidth: 40 }
                                }
                            });

                            // Save the PDF
                            const filename = `UBUS_Driver_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                            doc.save(filename);

                            // Create custom success modal
                            const successModal = $(`
                                <div class="modal" id="successModal" tabindex="-1" role="dialog" style="display: block;">
                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-body text-center p-4">
                                                <div class="mb-4">
                                                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                                                </div>
                                                <h4 class="mb-3">Success!</h4>
                                                <p class="mb-4">PDF generated successfully!</p>
                                                <button type="button" class="btn btn-primary px-4" onclick="closeSuccessModal()">
                                                    OK
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-backdrop fade show"></div>
                            `).appendTo('body');

                            // Add animation class
                            setTimeout(() => {
                                successModal.find('.modal-dialog').addClass('animate__animated animate__bounceIn');
                            }, 100);

                        } catch (error) {
                            console.error('PDF Generation Error:', error);
                            // Error modal
                            const errorModal = $(`
                                <div class="modal" id="errorModal" tabindex="-1" role="dialog" style="display: block;">
                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                            <div class="modal-body text-center p-4">
                                                <div class="mb-4">
                                                    <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
                                                </div>
                                                <h4 class="mb-3">Error</h4>
                                                <p class="mb-4">Failed to generate PDF. Please try again.</p>
                                                <button type="button" class="btn btn-danger px-4" onclick="closeErrorModal()">
                                                    OK
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-backdrop fade show"></div>
                            `).appendTo('body');

                            setTimeout(() => {
                                errorModal.find('.modal-dialog').addClass('animate__animated animate__bounceIn');
                            }, 100);
                        }
                    }).fail(function(error) {
                        console.error('API Error:', error);
                        // API Error modal
                        const errorModal = $(`
                            <div class="modal" id="errorModal" tabindex="-1" role="dialog" style="display: block;">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-body text-center p-4">
                                            <div class="mb-4">
                                                <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
                                            </div>
                                            <h4 class="mb-3">Error</h4>
                                            <p class="mb-4">Failed to fetch driver data. Please try again.</p>
                                            <button type="button" class="btn btn-danger px-4" onclick="closeErrorModal()">
                                                OK
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-backdrop fade show"></div>
                        `).appendTo('body');

                        setTimeout(() => {
                            errorModal.find('.modal-dialog').addClass('animate__animated animate__bounceIn');
                        }, 100);
                    });
                }

                // Function to close success modal
                function closeSuccessModal() {
                    const modal = $('#successModal');
                    const backdrop = $('.modal-backdrop');
                    
                    modal.find('.modal-dialog').addClass('animate__animated animate__fadeOut');
                    
                    setTimeout(() => {
                        modal.remove();
                        backdrop.remove();
                    }, 500);
                }

                // Function to close error modal
                function closeErrorModal() {
                    const modal = $('#errorModal');
                    const backdrop = $('.modal-backdrop');
                    
                    modal.find('.modal-dialog').addClass('animate__animated animate__fadeOut');
                    
                    setTimeout(() => {
                        modal.remove();
                        backdrop.remove();
                    }, 500);
                }
            
    </script>
</body>
</html>